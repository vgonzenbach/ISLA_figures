---
title: "ISLA comparison: Visualizing Proportion significant P-values across ROIs"
author: "Virgilio Gonzenbach"
date: "6/18/2021"
output:
  html_document: 
    keep_md: yes
    df_print: paged
    toc: true
    toc_float: true
    code_folding: hide
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning=FALSE,
                      cache=FALSE,
                      cache.path='cache/',
                      fig.path=here::here('results/figures/pprop_barplot/'),
                      fig.width = 10, 
                      fig.height = 7, 
                      dpi=300)

knitr::opts_knit$set(root.dir = '/home/vgonzenb/ISLA/')
```

```{r, include=FALSE}
 # Set to my library
myPaths = c(.libPaths(), "/home/vgonzenb/R/x86_64-pc-linux-gnu-library/4.0")
.libPaths(myPaths)
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library(stringr)
library(ggthemes)
library(gridExtra)
library(stargazer)
library(flextable)
library(hash)
# Load data
load_p_df = function(){
  p_df = read.csv(here::here('results/data/prop_sigPs_by_ROIadjBy10thr.csv'))
  colnames(p_df)[1] = "METHOD"
  
  # Separate first column
  p_df$METHOD = c("Uncorrected", "ISLA_R2", "ISLA_R3", "ISLA_R4", "NWC_R2", "NWC_R3", "NWC_R4", "BASIL")
  p_df = tidyr::separate(p_df, METHOD, into = c("method", "radius"), sep="_")
  
  # Prep method
  p_df$method = factor(p_df$method, levels=unique(p_df$method))
  
  # Prep radius
  p_df = p_df[rep(seq_len(nrow(p_df)), times = c(3,1,1,1,1,1,1,3)), ] # repeat Raw CBF 3 times to match
  p_df[p_df$method %in% c("Uncorrected", "BASIL"), "radius"] = c("R2", "R3", "R4") # fill in radius info for Raw CBF
  p_df$radius = factor(p_df$radius) %>% recode_factor(R2 = "R = 2", R3 = "R = 3", R4 = "R = 4") # recode for plotting
  
  return(p_df)
}

load_dict = function(){
  
  # Load ROI dictionary
  dict = readxl::read_xlsx(here::here("data/MUSE_ROI_Dict.xlsx"), 1)
  s_dict = dict[dict$ROI_INDEX %in% 2:300, ]
  s_dict$ROI_INDEX = paste0("X", s_dict$ROI_INDEX)
  s_dict[, c("LEFT_RIGHT", "Notes")] <- NULL
  return(s_dict)
}

load_gmd_info = function(){
  #' Load GMD average in ROI table
  gmd_df = read.csv(here::here('results/data/roi_gmd.csv'))
  gmd_df %>% rename(ROI_INDEX = X)
}

p_df = load_p_df()
s_dict = load_dict()
gmd_df = load_gmd_info()

# Split dataframe ROI class
subset_roi_df = function(roi_df, roi_indexes){
  roi_df = p_df %>% select(method, radius, any_of(roi_indexes))
  return(roi_df)
}

get_roi_info = function(roi_index, info=c("name", "side", "tissue")){
  #' Given ROI index return its name 
  if(is.null(s_dict)){
    print("No dictionary in memory") 
    return(NULL)
  }

  cols = c("ROI_NAME", "HEMISPHERE", "TISSUE_SEG")
  names(cols) = c("name", "side", "tissue")

  col = cols[info]
  rows = match(roi_index, s_dict$ROI_INDEX)
  roi_info = unname(unlist(s_dict[rows, col]))
  return(roi_info)
}

# Create list with Region information for each ROI
temporal = c(123, 122, 133, 155, 201, 203, 132, 154, 200, 202, 181, 185, 207, 180, 184, 206, 88, 87)
parietal = c(107, 177, 195, 199, 106, 176, 194, 198, 149, 169, 148, 168, 86, 85)
occipital = c(161, 160, 129, 145, 157, 197, 128, 144, 156, 196, 109, 115, 135, 108, 114, 134, 84, 83)
limbic = c(101, 139, 167, 100, 138, 166, 117, 171, 116, 170)
frontal = c(105, 137, 147, 179, 104, 136, 146, 178, 103, 173, 102, 172, 121, 143, 163, 165, 183, 191, 205, 120, 142, 162, 164, 182, 190, 204, 125, 141, 151, 153, 187, 193, 124, 140, 150, 152, 186, 192, 113, 119, 175, 112, 118, 174, 82, 81)
deep = c(30, 37, 56, 58, 23, 36, 55, 57, 60, 59, 92, 91, 90, 89, 94, 93, 32, 75, 48, 31, 76, 47)

roi_class = list(Frontal = paste0("X", frontal), Occipital = paste0("X", occipital), Temporal = paste0("X", temporal), Parietal = paste0("X", parietal), Limbic = paste0("X", limbic), Deep = paste0("X", deep))

s_dict <- data.frame(ROI_INDEX = unlist(roi_class) %>% unname(), 
           REGION = roi_class %>% unlist() %>% names() %>% str_extract("[A-Za-z]+")) %>% 
  right_join(s_dict, by = "ROI_INDEX")

```

## ROIs

```{r}
gmd_df %>% 
  left_join(s_dict, by = "ROI_INDEX") %>% 
  group_by(REGION) %>% arrange(desc(AVG_GMD), .by_group = TRUE)
```

## Plots: Examining statistical significance across ROIs

```{r}
plot_regions = function(roi_df, title="", x_text_size=7){
  #' Plot barplots of proportion significant Ps in given ROI
    
  df_long = roi_df %>% pivot_longer(!c("method", "radius"), names_to = "ROI", values_to = "PROP. SIG. P-VALUES", names_ptypes = list(ROI = factor()))
  
  # Order ROIs by Raw CBF
  roi_order = df_long$`PROP. SIG. P-VALUES`[df_long$method == "Uncorrected" & df_long$radius == "R = 2"] %>% order(decreasing = TRUE)
  df_long$ROI = factor(df_long$ROI, levels=levels(df_long$ROI)[roi_order])
  
  # Plot
  df_long %>% ggplot(aes(x=ROI, y=`PROP. SIG. P-VALUES`, fill=method)) + geom_bar(position = 'dodge', stat = 'identity') + 
    theme_classic() + 
    scale_fill_calc(name = "Method") + facet_wrap(~radius) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=x_text_size)) + 
    ggtitle(title) + theme(plot.title = element_text(hjust = 0.5))
  
}
```

### Select ROIs

```{r}
# selected ROIS in meeting with Kristin 10/13/22
selected_rois = c('X56', 'X58', 'X32', 'X48', # deep
                  'X103', 'X143', 'X187', # frontal
                  'X101', 'X139', # limbic
                  'X145', 'X115', # occipital
                  'X169', 'X149', # parietal
                  'X201', 'X207' # temporal
                  )
roi_df = p_df %>% 
  pivot_longer(-c(method, radius), names_to='ROI_INDEX', values_to = 'PROP. SIG. P-VALUES') %>% 
  filter(ROI_INDEX %in% selected_rois) %>% 
  left_join(s_dict %>% select(ROI_INDEX, ROI_NAME), by = 'ROI_INDEX') %>% 
  mutate(ROI_NAME = ROI_NAME %>% stringr::str_replace_all('Left', 'L.') %>% 
           str_replace_all('Cun|MOG|ACgG|SCA|MCgG|MPoG|STG|AIns|MFG|PCu|TTG', '') %>% 
           str_squish() %>% 
           str_to_title())

roi_df %>% 
  ggplot(aes(x=ROI_NAME, y=`PROP. SIG. P-VALUES`, fill=method)) + 
  geom_bar(position = position_dodge(-.9), stat='identity') + 
  scale_fill_calc(name = "Method") +
  facet_wrap(~radius) + 
  coord_flip() + 
  xlab('ROI') +
  ylab('Proportion Sig. P-values') + 
  theme_bw() 


```

### Frontal (Left)

```{r frontal_l_plot}
frontal_side = get_roi_info(roi_class$Frontal, "side")

# Add new ROI class to roi_class list of indexes
roi_class[["Frontal L"]] = roi_class$Frontal[frontal_side == "Left"]

p_df %>% subset_roi_df(roi_class[["Frontal L"]]) %>% plot_regions(title = "Frontal (Left)", x_text_size = 8) + coord_flip()
```

### Frontal (Right)

```{r frontal_r_plot}
roi_class[["Frontal R"]] = roi_class$Frontal[frontal_side == "Right"]
p_df %>% subset_roi_df(roi_class[["Frontal R"]]) %>% plot_regions(title = "Frontal (Right)", x_text_size = 8) + coord_flip()
```

### Temporal

```{r temporal_plot}
p_df %>% subset_roi_df(roi_class[["Temporal"]]) %>% plot_regions(title = "Temporal", x_text_size = 9) + coord_flip()
```

### Parietal

```{r parietal_plot}
p_df %>% subset_roi_df(roi_class[["Parietal"]]) %>% plot_regions(title = "Parietal", x_text_size = 9) + coord_flip()
```

### Occipital

```{r occipital_plot}
p_df %>% subset_roi_df(roi_class[["Occipital"]]) %>% plot_regions(title = "Occipital", 9) + coord_flip()
```

### Deep

```{r deep_plot}
p_df %>% subset_roi_df(roi_class[["Deep"]]) %>% plot_regions(title = "Deep", 9) + coord_flip()
```

### Limbic

```{r limbic_plot}
p_df %>% subset_roi_df(roi_class[["Limbic"]]) %>% plot_regions(title = "Limbic", 9) + coord_flip()
```

## Tables: Examine ROIs

Note: JLF parcellation consists of 135 labels while MUSE has 145 ROIs. TODO: Why is there a discrepancy?
  
  Which MUSE ROIs are not included in JLF parcellation? Most White Matter regions

```{r, results='asis'}
isInJLF = s_dict$ROI_INDEX %in% gmd_df$ROI_INDEX

#isInMUSE = thresh_df$X %in% s_dict$ROI_INDEX 

#jlf_dict$ROI_INDEX == readr::parse_number(thresh_df$X[!isInMUSE])
#
#isOnlyInJLF = jlf_dict$ROI_INDEX %in% readr::parse_number(thresh_df$X[!isInMUSE])
#jlf_dict[isOnlyInJLF,] # TODO: Figure out what do with this

index_tbl = s_dict[isInJLF, c("ROI_INDEX", "ROI_NAME")] 

start = seq(1,130, by=26)
end = start + 25

index_tbl_cols = data.frame(index_tbl[start[1]:end[1],])
for(i in 2:length(start)){
  index_tbl_cols = data.frame(index_tbl_cols, index_tbl[start[i]:end[i],])
  i = i + 1
}

appendixA = index_tbl_cols %>% flextable::flextable() %>% set_header_labels(ft,
                                                                            values = list(ROI_INDEX = "INDEX",
                                                                                          ROI_NAME = "ROI",
                                                                                          ROI_INDEX.1 = "INDEX",
                                                                                          ROI_NAME.1 = "ROI",
                                                                                          ROI_INDEX.2 = "INDEX",
                                                                                          ROI_NAME.2 = "ROI",
                                                                                          ROI_INDEX.3 = "INDEX",
                                                                                          ROI_NAME.3 = "ROI",
                                                                                          ROI_INDEX.4 = "INDEX",
                                                                                          ROI_NAME.4 = "ROI")) 
appendixA

dir.create(here::here('results/tables'))
save_as_html(appendixA, path = here::here('results/tables/AppendixA.html'))
```

